<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>è©±ã—åˆã„æ•´ç†ã‚°ãƒ©ãƒ¬ã‚³ãƒ»AIç‰ˆï¼ˆãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ï¼‰</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      background: #f7f7f7;
    }
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
    }
    .tab.active {
      background: #ffffff;
      border-bottom: 2px solid #2196f3;
      font-weight: bold;
    }

    #main {
      flex: 1;
      display: flex;
    }

    #student-view, #teacher-view {
      display: none;
      width: 100%;
    }
    #student-view.active, #teacher-view.active {
      display: flex;
    }

    #left, #right {
      box-sizing: border-box;
      padding: 16px;
    }
    #left {
      width: 35%;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #right {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    h2 {
      margin: 0 0 4px;
      font-size: 18px;
    }
    h3 {
      margin: 8px 0 4px;
      font-size: 14px;
    }

    input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      resize: vertical;
      min-height: 80px;
      font-size: 12px;
    }

    /* å††å½¢ãƒ•ã‚§ãƒ¼ã‚ºãƒãƒƒãƒ— */
    #phase-circle-wrapper {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }
    #phaseCircle {
      position: relative;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      border: 1px dashed #b0bec5;
      background: #fafafa;
      flex-shrink: 0;
    }
    .phase-dot {
      position: absolute;
      transform: translate(-50%, -50%);
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 16px;
      border: 1px solid #90caf9;
      background: #e3f2fd;
      cursor: pointer;
      white-space: nowrap;
    }
    .phase-dot.current {
      background: #1976d2;
      color: #fff;
      border-color: #1565c0;
      font-weight: bold;
    }
    .phase-dot.visited:not(.current) {
      background: #bbdefb;
      border-color: #64b5f6;
    }
    #phase-circle-center {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
      color: #666;
      text-align: center;
      width: 70%;
      line-height: 1.4;
    }

    #phase-caption-text {
      font-size: 12px;
      color: #555;
    }

    .keyword-zone-title {
      font-size: 13px;
      font-weight: bold;
      margin-top: 4px;
      margin-bottom: 2px;
    }
    .keyword-zone-title span.icon {
      margin-right: 4px;
    }
    .keyword-zone-sub {
      font-size: 11px;
      color: #777;
      margin-bottom: 4px;
    }

    #keywords-user,
    #keywords-ai {
      border: 1px solid #ccc;
      min-height: 80px;
      padding: 8px;
      background: #fffef5;
      overflow-y: auto;
      margin-bottom: 4px;
    }
    #keywords-ai {
      background: #f3f8ff;
      border-style: dashed;
    }

    .keyword-input-row {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
    }
    .keyword-input-row input {
      flex: 1;
    }

    button {
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .keyword-card {
      background: #fff8c6;
      border: 1px solid #e0c050;
      padding: 4px 8px;
      margin-bottom: 4px;
      cursor: grab;
      font-size: 12px;
      display: inline-block;
    }

    .keyword-card div.quote {
      font-size: 10px;
      color: #555;
      margin-top: 2px;
    }

    .subject-badge {
      display: inline-block;
      margin-left: 4px;
      padding: 1px 4px;
      border-radius: 8px;
      font-size: 10px;
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }

    #canvas-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #canvas-header {
      margin-bottom: 4px;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    #canvas-title-block {
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
    }
    #canvas-title-block input {
      flex: 1;
      padding: 4px 6px;
    }
    #worksheet-phase-label {
      font-size: 12px;
      color: #555;
      white-space: nowrap;
    }

    #canvas {
      flex: 1;
      border: 1px solid #aaa;
      position: relative;
      background: #fdfdfd;
      overflow: hidden;
    }

    .area {
      position: absolute;
      border: 1px dashed #999;
      box-sizing: border-box;
      padding: 4px;
      font-size: 12px;
      color: #555;
      background: rgba(255,255,255,0.7);
    }

    /* ã•ãã‚‹ãƒ»ãã¥ã */
    .layout-saguru-kizuku #area-target {
      top: 4px; left: 4px; right: 4px; height: 16%;
      border-color: #9c27b0;
      background: rgba(243, 229, 245, 0.9);
    }
    .layout-saguru-kizuku #area-fact {
      top: 22%; left: 4px; right: 50%; height: 38%;
      border-color: #4caf50;
      background: rgba(232, 245, 233, 0.9);
    }
    .layout-saguru-kizuku #area-wish {
      top: 22%; left: 50%; right: 4px; height: 24%;
      border-color: #3f51b5;
      background: rgba(232, 234, 246, 0.9);
    }
    .layout-saguru-kizuku #area-interpret {
      top: 48%; left: 50%; right: 4px; height: 26%;
      border-color: #ff9800;
      background: rgba(255, 243, 224, 0.9);
    }

    /* ã²ã‚‰ã‚ã */
    .layout-hirameku #hirameku-core {
      top: 35%; left: 30%; right: 30%; height: 30%;
      border-color: #3f51b5;
      background: rgba(232, 234, 246, 0.95);
    }
    .layout-hirameku .idea-slot {
      position: absolute;
      width: 22%;
      height: 26%;
      border: 1px dashed #2196f3;
      background: rgba(227, 242, 253, 0.8);
      box-sizing: border-box;
      padding: 4px;
      font-size: 12px;
      color: #555;
    }

    /* ã¤ãã‚‹ */
    .layout-tsukuru #area-idea-name {
      top: 4px; left: 4px; right: 40%; height: 14%;
      border-color: #673ab7;
      background: rgba(237, 231, 246, 0.95);
    }
    .layout-tsukuru #area-core-problem {
      top: 4px; left: 60%; right: 4px; height: 14%;
      border-color: #3f51b5;
      background: rgba(232, 234, 246, 0.95);
    }
    .layout-tsukuru #area-look {
      top: 22%; left: 4px; width: 48%; height: 32%;
      border-color: #009688;
      background: rgba(224, 242, 241, 0.9);
    }
    .layout-tsukuru #area-size {
      top: 22%; left: 52%; right: 4px; height: 32%;
      border-color: #795548;
      background: rgba(239, 235, 233, 0.9);
    }
    .layout-tsukuru #area-function {
      top: 58%; left: 4px; width: 48%; height: 34%;
      border-color: #2196f3;
      background: rgba(227, 242, 253, 0.9);
    }
    .layout-tsukuru #area-feature {
      top: 58%; left: 52%; right: 4px; height: 34%;
      border-color: #ff9800;
      background: rgba(255, 243, 224, 0.9);
    }

    /* ãŸã‚ã™ */
    .layout-tamesu #area-good {
      top: 4px; left: 4px; width: 32%; bottom: 4px;
      border-color: #4caf50;
      background: rgba(232, 245, 233, 0.9);
    }
    .layout-tamesu #area-better {
      top: 4px; left: 34%; width: 32%; bottom: 4px;
      border-color: #ff9800;
      background: rgba(255, 243, 224, 0.9);
    }
    .layout-tamesu #area-next {
      top: 4px; left: 66%; right: 4px; bottom: 4px;
      border-color: #2196f3;
      background: rgba(227, 242, 253, 0.9);
    }

    .area-label {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .area-label span.icon {
      font-size: 14px;
    }
    .area-hint {
      font-size: 10px;
      color: #555;
    }

    .note {
      position: absolute;
      background: #fff9c4;
      border: 1px solid #f0c000;
      padding: 4px 6px;
      font-size: 12px;
      cursor: move;
      max-width: 160px;
      word-wrap: break-word;
      box-shadow: 1px 1px 2px rgba(0,0,0,0.15);
    }

    #step-guide {
      border-top: 1px solid #ddd;
      padding: 6px 10px;
      font-size: 12px;
      background: #fafafa;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .step {
      padding: 4px 6px;
      border-radius: 4px;
      background: #e3f2fd;
      border: 1px solid #90caf9;
    }
    .step span.label {
      font-weight: bold;
      margin-right: 4px;
    }

    .next-phase-buttons {
      font-size: 11px;
      text-align: right;
      margin-bottom: 4px;
    }
    .next-phase-buttons button {
      font-size: 11px;
      padding: 2px 6px;
      margin-left: 4px;
      border-radius: 12px;
      border: 1px solid #90caf9;
      background: #e3f2fd;
      cursor: pointer;
    }

    /* å…ˆç”Ÿãƒ“ãƒ¥ãƒ¼ç°¡ç•¥ */
    #teacher-left {
      width: 30%;
      border-right: 1px solid #ccc;
      padding: 16px;
      box-sizing: border-box;
    }
    #teacher-right {
      flex: 1;
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .team-item {
      padding: 6px 8px;
      border: 1px solid #ccc;
      margin-bottom: 4px;
      cursor: pointer;
      font-size: 13px;
      border-radius: 4px;
      background: #fff;
    }
    .team-item.active {
      background: #e3f2fd;
      border-color: #64b5f6;
    }
    .teacher-subject-badge {
      display: inline-block;
      margin-left: 4px;
      padding: 1px 4px;
      border-radius: 8px;
      font-size: 10px;
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }
  </style>
</head>
<body>
  <div id="tabs">
    <div class="tab active" data-target="student-view">ç”Ÿå¾’ç”¨</div>
    <div class="tab" data-target="teacher-view">å…ˆç”Ÿç”¨ï¼ˆãƒ‡ãƒ¢ï¼‰</div>
  </div>

  <div id="main">
    <!-- ç”Ÿå¾’ãƒ“ãƒ¥ãƒ¼ -->
    <div id="student-view" class="active">
      <div id="left">
        <div>
          <h2>â‘  è©±ã—åˆã„ã®ãƒ†ãƒ¼ãƒ</h2>
          <input id="topicInput" type="text" placeholder="ä¾‹ï¼šAIãŒæ¢ç©¶ã®è‡ªèµ°ã‚’ä¿ƒé€²ã•ã›ã‚‹ãŸã‚ã«ã¯ï¼Ÿ" />
        </div>

        <div>
          <h3>â‘¡ ãƒ•ã‚§ãƒ¼ã‚ºé¸æŠï¼ˆå††ãƒãƒƒãƒ—ï¼‰</h3>
          <div id="phase-circle-wrapper">
            <div id="phaseCircle">
              <div id="phase-circle-center">
                ãƒ•ã‚§ãƒ¼ã‚ºã¯ãã‚‹ãã‚‹<br>è¡Œãæ¥ã—ã¦OK
              </div>
              <div class="phase-dot" data-phase="saguru"  id="dot-saguru">â‘ ã•ãã‚‹</div>
              <div class="phase-dot" data-phase="kizuku"  id="dot-kizuku">â‘¡ãã¥ã</div>
              <div class="phase-dot" data-phase="hirameku" id="dot-hirameku">â‘¢ã²ã‚‰ã‚ã</div>
              <div class="phase-dot" data-phase="tsukuru" id="dot-tsukuru">â‘£ã¤ãã‚‹</div>
              <div class="phase-dot" data-phase="tamesu"  id="dot-tamesu">â‘¤ãŸã‚ã™</div>
            </div>
            <div id="phase-caption-text">
              å††ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ä»Šã©ã®ãƒ•ã‚§ãƒ¼ã‚ºã§è€ƒãˆã‚‹ã‹æ±ºã‚ã¾ã™ã€‚
            </div>
          </div>
        </div>

        <div>
          <h3>â‘¢ ãƒ¡ãƒ¢ï¼ˆç™ºè¨€ãƒ»æ–‡å­—èµ·ã“ã—ã‚’æ›¸ãç•™ã‚ã‚‹ï¼‰</h3>
          <textarea id="rawMemo" placeholder="ç™ºè¨€ãƒ¡ãƒ¢ã‚„æ–‡å­—èµ·ã“ã—çµæœãŒã“ã“ã«å…¥ã‚Šã¾ã™"></textarea>

          <div style="margin-top:4px; font-size:12px;">
            éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆm4a / wav ãªã©ï¼‰ï¼š
            <input id="audioFileInput" type="file" accept="audio/*" />
          </div>
          <div style="margin-top:4px; font-size:12px;">
            <button id="uploadAudioBtn">éŸ³å£°ã‚’æ–‡å­—èµ·ã“ã—ã™ã‚‹</button>
            <span id="transcribeStatus" style="margin-left:8px; color:#555;"></span>
          </div>

          <div style="margin-top:8px; font-size:12px; border-top:1px dashed #ccc; padding-top:4px;">
            ãƒ–ãƒ©ã‚¦ã‚¶ã§ç›´æ¥éŒ²éŸ³ã™ã‚‹ï¼š
            <button id="startRecordBtn">éŒ²éŸ³é–‹å§‹</button>
            <button id="stopRecordBtn" disabled>åœæ­¢ã—ã¦æ–‡å­—èµ·ã“ã—</button>
            <span id="recordStatus" style="margin-left:8px; color:#c62828;"></span>
          </div>

          <div style="margin-top:8px; font-size:12px;">
            <button id="aiKeywordBtn">AIã§ãƒ•ã‚§ãƒ¼ã‚ºã«åˆã£ãŸã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™</button>
            <span id="aiKeywordStatus" style="margin-left:8px; color:#555;"></span>
          </div>
        </div>

        <div>
          <h3>â‘£ é‡è¦ãã†ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ãƒ•ãƒ¬ãƒ¼ã‚º</h3>
          <div class="keyword-input-row">
            <input id="keywordInput" type="text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’1ã¤å…¥åŠ›ï¼ˆä¾‹ï¼šå†…ç™ºçš„å‹•æ©Ÿã¥ã‘ï¼‰" />
            <button id="addKeywordBtn">è¿½åŠ </button>
          </div>

          <div style="font-size:12px; margin-bottom:4px;">
            ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ç´ã¥ã‘ã‚‹æ•™ç§‘ã‚¿ã‚°ï¼š
            <select id="subjectSelect">
              <option value="">ï¼ˆãªã—ï¼‰</option>
              <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
              <option value="ç†ç§‘">ç†ç§‘</option>
              <option value="å›½èª">å›½èª</option>
              <option value="æ•°å­¦">æ•°å­¦</option>
              <option value="ç·åˆãƒ»æ¢ç©¶">ç·åˆãƒ»æ¢ç©¶</option>
            </select>
            <span style="margin-left:4px; color:#777;">
              â€» ã“ã®é¸æŠã¯ã€Œæ¬¡ã«è¿½åŠ ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã«ã ã‘åæ˜ ã•ã‚Œã¾ã™ã€‚
            </span>
          </div>

          <div class="keyword-zone-title">
            <span class="icon">âœï¸</span>è‡ªåˆ†ã§è¦‹ã¤ã‘ãŸï¼AIã‹ã‚‰ã‚‚ã‚‰ã£ãŸã‚«ãƒ¼ãƒ‰
          </div>
          <div class="keyword-zone-sub">
            ãƒ¡ãƒ¢ã‚„AIã®ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ãªãŒã‚‰ã€æ°—ã«ãªã£ãŸè¨€è‘‰ãƒ»ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’1è¡Œãšã¤è¿½åŠ ã™ã‚‹ã€‚
          </div>
          <div id="keywords-user"></div>

          <div class="keyword-zone-title" style="margin-top:8px;">
            <span class="icon">âœ¨</span>AIã®ææ¡ˆã‚«ãƒ¼ãƒ‰ï¼ˆãƒ­ã‚°ç”¨ï¼‰
          </div>
          <div class="keyword-zone-sub">
            ç›´è¿‘ã§AIãŒææ¡ˆã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¨˜éŒ²ã—ã¦ãŠãã‚¨ãƒªã‚¢ï¼ˆãƒ‰ãƒ©ãƒƒã‚°å…ƒã¨ã—ã¦ã‚‚ä½¿ãˆã¾ã™ï¼‰ã€‚
          </div>
          <div id="keywords-ai"></div>
        </div>
      </div>

      <div id="right">
        <div id="canvas-wrapper">
          <div id="canvas-header">
            <div id="canvas-title-block">
              <span>â‘¤ ã‚¿ã‚¤ãƒˆãƒ«ï¼š</span>
              <input id="canvasTitle" type="text" placeholder="è©±ã—åˆã„ï¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã" />
            </div>
            <div id="worksheet-phase-label">
              ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆï¼šã•ãã‚‹ãƒ»æ°—ã¥ããƒ»ãŸã¦ã‚‹
            </div>
          </div>

          <div class="next-phase-buttons" id="nextPhaseButtons"></div>

          <div id="canvas" class="layout-saguru-kizuku">
            <!-- ã•ãã‚‹ãƒ»ãã¥ã -->
            <div id="area-target" class="area">
              <div class="area-label"><span class="icon">ğŸ¯</span>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</div>
              <div class="area-hint">èª°ã®å›°ã‚Šã”ã¨ã‚’è€ƒãˆã¦ã„ã‚‹ï¼Ÿï¼ˆä¾‹ï¼šãŠæ¯ã•ã‚“ã€ä¸­å­¦ç”Ÿãªã©ï¼‰</div>
            </div>
            <div id="area-fact" class="area">
              <div class="area-label"><span class="icon">ğŸ“Œ</span>ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ãƒ»è¡Œå‹•è¦³å¯Ÿï¼ˆäº‹å®Ÿï¼‰</div>
              <div class="area-hint">å®Ÿéš›ã®ç™ºè¨€ã‚„æ§˜å­ã®ã‚«ãƒ¼ãƒ‰ã‚’è²¼ã‚‹ã€‚</div>
            </div>
            <div id="area-wish" class="area">
              <div class="area-label"><span class="icon">â“</span>æœ¬å½“ã®é¡˜ã„ã”ã¨ãƒ»å›°ã‚Šã”ã¨</div>
              <div class="area-hint">â€» ä¸€è¡Œã®å•ã„ã«ã¾ã¨ã‚ã‚‹æ¬„ã€‚ã‚«ãƒ¼ãƒ‰ã‚’ãƒ’ãƒ³ãƒˆã«è‡ªåˆ†ã®è¨€è‘‰ã§æ›¸ãã€‚</div>
              <input id="coreProblemInput" type="text"
                     placeholder="ä¾‹ï¼šã©ã†ã™ã‚Œã°ã€ã€œã§ãã‚‹ã ã‚ã†ã‹ï¼Ÿ"
                     style="width:100%; margin-top:4px; font-size:12px; padding:4px 6px; box-sizing:border-box;" />
            </div>
            <div id="area-interpret" class="area">
              <div class="area-label"><span class="icon">ğŸ§©</span>é¡˜ã„ã”ã¨ãƒ»å›°ã‚Šã”ã¨ï¼ˆè§£é‡ˆï¼‰</div>
              <div class="area-hint">ã€Œã€œãªã®ã‹ã‚‚ã€ã€Œã€œã ã‹ã‚‰ã‹ã‚‚ã€ã¨æ„Ÿã˜ãŸã“ã¨ã®ã‚«ãƒ¼ãƒ‰ã‚’è²¼ã‚‹ã€‚</div>
            </div>

            <!-- ã²ã‚‰ã‚ã -->
            <div id="hirameku-core" class="area" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ¯</span>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æœ¬å½“ã®èª²é¡Œ</div>
              <div class="area-hint">ã•ãã‚‹ãƒ»ãã¥ããƒ•ã‚§ãƒ¼ã‚ºã§æ±ºã‚ãŸå•ã„ã‚’ã“ã“ã«ç½®ãã€‚</div>
              <div id="hiramekuCoreProblemText"
                   style="margin-top:4px; font-size:12px; padding:4px 6px; background:#fff; border-radius:4px; min-height:18px;"></div>
            </div>
            <div id="hirameku-idea-slot-1" class="idea-slot" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ’¡</span>ã‚¢ã‚¤ãƒ‡ã‚¢</div>
              <div class="area-hint">æ€ã„ã¤ã„ãŸå·¥å¤«ã®ã‚«ãƒ¼ãƒ‰ã‚’è²¼ã‚‹ã€‚</div>
            </div>
            <div id="hirameku-idea-slot-2" class="idea-slot" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ’¡</span>ã‚¢ã‚¤ãƒ‡ã‚¢</div>
              <div class="area-hint">åˆ¥ã®è¦–ç‚¹ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚‚æ­“è¿ã€‚</div>
            </div>
            <div id="hirameku-idea-slot-3" class="idea-slot" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ’¡</span>ã‚¢ã‚¤ãƒ‡ã‚¢</div>
              <div class="area-hint">å°ã•ãªä¸€æ­©ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚‚OKã€‚</div>
            </div>
            <div id="hirameku-idea-slot-4" class="idea-slot" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ’¡</span>ã‚¢ã‚¤ãƒ‡ã‚¢</div>
              <div class="area-hint">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ°—æŒã¡ã«å¯„ã‚Šãã£ãŸæ¡ˆã€‚</div>
            </div>

            <!-- ã¤ãã‚‹ -->
            <div id="area-idea-name" class="area" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ·</span>ã‚¢ã‚¤ãƒ‡ã‚¢ã®åå‰</div>
              <div class="area-hint">ä¾‹ï¼šå®‰çœ ãƒ ãƒ¼ãƒ‰BOX ãªã©ã€‚</div>
            </div>
            <div id="area-core-problem" class="area" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ¯</span>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æœ¬å½“ã®èª²é¡Œ</div>
              <div class="area-hint">ç™ºè¡¨ã¾ã¨ã‚ã‚„å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã¨åŒã˜å•ã„ã‚’è¡¨ç¤ºã€‚</div>
              <div id="coreProblemDisplay"
                   style="margin-top:4px; font-size:12px; padding:4px 6px; background:#fff; border-radius:4px; min-height:18px;"></div>
            </div>
            <div id="area-look" class="area" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ‘€</span>è¦‹ãŸç›®</div>
              <div class="area-hint">å½¢ãƒ»è‰²ãƒ»é›°å›²æ°—ãªã©ã®ã‚«ãƒ¼ãƒ‰ã€‚</div>
            </div>
            <div id="area-size" class="area" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ“</span>å¤§ãã•</div>
              <div class="area-hint">ã©ã‚Œãã‚‰ã„ã®å¤§ãã•ã‹ãƒ»æŒã¡é‹ã³ã‚„ã™ã•ãªã©ã€‚</div>
            </div>
            <div id="area-function" class="area" style="display:none;">
              <div class="area-label"><span class="icon">âš™ï¸</span>æ©Ÿèƒ½</div>
              <div class="area-hint">ã©ã‚“ãªæ©Ÿèƒ½ã§èª²é¡Œã‚’è§£æ±ºã™ã‚‹ã‹ã€‚</div>
            </div>
            <div id="area-feature" class="area" style="display:none;">
              <div class="area-label"><span class="icon">â­</span>ç‰¹å¾´ãƒ»ã“ã ã‚ã‚Š</div>
              <div class="area-hint">ä»–ã¨é•ã†ãƒã‚¤ãƒ³ãƒˆãƒ»å·¥å¤«ã—ãŸç‚¹ã€‚</div>
            </div>

            <!-- ãŸã‚ã™ -->
            <div id="area-good" class="area" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ‘</span>è‰¯ã‹ã£ãŸã¨ã“ã‚</div>
              <div class="area-hint">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã»ã‚ã‚‰ã‚ŒãŸç‚¹ãƒ»ã†ã¾ãã„ã£ãŸç‚¹ã€‚</div>
            </div>
            <div id="area-better" class="area" style="display:none;">
              <div class="area-label"><span class="icon">ğŸ”§</span>ã‚‚ã£ã¨ã“ã†ã ã£ãŸã‚‰è‰¯ã„ã¨ã“ã‚</div>
              <div class="area-hint">æ”¹å–„ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„æŒ‡æ‘˜ã®ã‚«ãƒ¼ãƒ‰ã€‚</div>
            </div>
            <div id="area-next" class="area" style="display:none;">
              <div class="area-label"><span class="icon">â¡ï¸</span>æ¬¡ã«å–ã‚Šçµ„ã‚€ã“ã¨</div>
              <div class="area-hint">æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã§è©¦ã—ãŸã„ä¸€æ­©ã€‚</div>
            </div>
          </div>
        </div>

        <div id="step-guide">
          <div class="step"><span class="label">STEP1</span> ãƒ†ãƒ¼ãƒã‚’æ›¸ã</div>
          <div class="step"><span class="label">STEP2</span> å††ã‹ã‚‰ãƒ•ã‚§ãƒ¼ã‚ºã‚’é¸ã¶</div>
          <div class="step"><span class="label">STEP3</span> éŸ³å£°ã‚’æ–‡å­—èµ·ã“ã— or ãƒ¡ãƒ¢ã‚’æ›¸ã</div>
          <div class="step"><span class="label">STEP4</span> AIã§ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ã€ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã«è²¼ã£ã¦æ•´ç†</div>
        </div>
      </div>
    </div>

    <!-- å…ˆç”Ÿãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ -->
    <div id="teacher-view">
      <div id="teacher-left">
        <h2>å…ˆç”Ÿç”¨ï¼šç­ã®ä¸€è¦§</h2>
        <p style="font-size:12px;color:#666;">
          ç”Ÿå¾’ãŒä½œæˆã—ãŸã‚°ãƒ©ãƒ¬ã‚³ï¼ˆãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆï¼‰ã‚’ç­ã”ã¨ã«ä¸€è¦§ã§è¦‹ã‚‹æƒ³å®šã®ãƒ‡ãƒ¢ã§ã™ã€‚
        </p>
        <div id="teamList">
          <div class="team-item active" data-team="A">Aç­ï¼šAIãŒæ¢ç©¶ã®è‡ªèµ°ã‚’ä¿ƒé€²ã•ã›ã‚‹ã«ã¯ï¼Ÿ</div>
          <div class="team-item" data-team="B">Bç­ï¼šçµ¦é£Ÿã®æ®‹èœã‚’æ¸›ã‚‰ã™ã«ã¯ï¼Ÿ</div>
          <div class="team-item" data-team="C">Cç­ï¼šå­¦æ ¡å›³æ›¸é¤¨ã‚’ã‚‚ã£ã¨ä½¿ã£ã¦ã‚‚ã‚‰ã†ã«ã¯ï¼Ÿ</div>
        </div>
      </div>
      <div id="teacher-right">
        <div id="teacher-summary" style="border:1px solid #ccc;padding:8px;background:#fafafa;font-size:13px;">
          <h3>é¸æŠä¸­ã®ç­ã®ã‚µãƒãƒª</h3>
          <div id="teacherSubjectBadge" style="font-size:12px; margin-bottom:4px;">
            æ•™ç§‘ã‚¿ã‚°ï¼š
            <span class="teacher-subject-badge">æ¢ç©¶</span>
            <span class="teacher-subject-badge">ç¤¾ä¼š</span>
          </div>
          <div id="summaryText">
            äº‹å®Ÿï¼š3æšï¼åŸå› ï¼š2æšï¼ã‚¢ã‚¤ãƒ‡ã‚¢ï¼š5æšï¼ˆä»®ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰<br/>
            ãƒ»äº‹å®ŸãŒã‚„ã‚„å°‘ãªã‚<br/>
            ãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢ãŒå¤šã„ãŒã€åŸå› ã¨ã¤ãªãŒã£ã¦ã„ãªã„ã‚‚ã®ã‚‚ã‚ã‚Šãã†
          </div>
        </div>
        <div id="teacher-feedback" style="border:1px solid #ccc;padding:8px;background:#fffef5;font-size:13px;">
          <h3>å…ˆç”Ÿã¸ã®å£°ã‹ã‘ã®ãƒ’ãƒ³ãƒˆï¼ˆä¾‹ï¼‰</h3>
          <ul id="feedbackList">
            <li>äº‹å®Ÿãƒ»ç¾çŠ¶ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚‚ã†å°‘ã—å¢—ã‚„ã™ã‚ˆã†å•ã„ã‹ã‘ã‚‹ã€‚</li>
            <li>ã‚¢ã‚¤ãƒ‡ã‚¢ã”ã¨ã«ã€Œã©ã®åŸå› ã«åŠ¹ããã†ã‹ï¼Ÿã€ã‚’èã„ã¦ã¿ã‚‹ã€‚</li>
            <li>æ¬¡ã«è©¦ã—ãŸã„ä¸€æ­©ã‚’1ã¤é¸ã°ã›ã€æœŸé™ã‚„å½¹å‰²ã‚’æ±ºã‚ã•ã›ã‚‹ã€‚</li>
          </ul>
          <p style="font-size:11px;color:#666;">
            â€» ç¾æ®µéšã§ã¯ãƒ€ãƒŸãƒ¼ã®å†…å®¹ã§ã™ãŒã€å°†æ¥ã¯ç”Ÿå¾’ã®ã‚°ãƒ©ãƒ¬ã‚³å†…å®¹ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã™ã‚‹æƒ³å®šã§ã™ã€‚
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
const tabs = document.querySelectorAll('.tab');
const studentView = document.getElementById('student-view');
const teacherView = document.getElementById('teacher-view');
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    const target = tab.dataset.target;
    if (target === 'student-view') {
      studentView.classList.add('active');
      teacherView.classList.remove('active');
    } else {
      studentView.classList.remove('active');
      teacherView.classList.add('active');
    }
  });
});

// å††ãƒãƒƒãƒ—
const phaseDots = {
  saguru:  document.getElementById("dot-saguru"),
  kizuku:  document.getElementById("dot-kizuku"),
  hirameku:document.getElementById("dot-hirameku"),
  tsukuru: document.getElementById("dot-tsukuru"),
  tamesu:  document.getElementById("dot-tamesu")
};
let currentPhase = "saguru";
const visitedPhases = new Set(["saguru"]);

(function layoutPhaseDots() {
  const circle = document.getElementById("phaseCircle");
  const w = circle.clientWidth || 180;
  const h = circle.clientHeight || 180;
  const cx = w / 2;
  const cy = h / 2;
  const r = Math.min(w, h) * 0.42;
  const order = ["saguru","kizuku","hirameku","tsukuru","tamesu"];
  order.forEach((ph, idx) => {
    const angle = -Math.PI / 2 + (2 * Math.PI * idx) / order.length; // 12æ™‚ã‹ã‚‰æ™‚è¨ˆå›ã‚Š
    const x = cx + r * Math.cos(angle);
    const y = cy + r * Math.sin(angle);
    const dot = phaseDots[ph];
    if (dot) {
      dot.style.left = x + "px";
      dot.style.top  = y + "px";
    }
  });
})();

const worksheetPhaseLabel = document.getElementById("worksheet-phase-label");
const nextPhaseButtons = document.getElementById("nextPhaseButtons");

// ãƒ•ã‚§ãƒ¼ã‚ºèª¬æ˜ãƒ»ãŠã™ã™ã‚é·ç§»
const phaseDescriptions = {
  saguru: "ã•ãã‚‹ï¼šã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ç¾çŠ¶ã®å›°ã‚Šã”ã¨ãƒ»è¦³å¯Ÿã‚’ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã«æ•´ç†ã—ã¾ã™ï¼ˆ6ã€œ10æšç¨‹åº¦ï¼‰ã€‚",
  kizuku: "ãã¥ãï¼šæœ¬å½“ã«è§£ããŸã„å•é¡Œãƒ»å•ã„ã‚’çµã‚Šè¾¼ã¿ã¾ã™ï¼ˆ3ã€œ5æšç¨‹åº¦ï¼‰ã€‚",
  hirameku: "ã²ã‚‰ã‚ãï¼šã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æœ¬å½“ã®èª²é¡Œã‚’ä¸­å¿ƒã«ã€è§£æ±ºã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å¤šã‚ã«å‡ºã—ã¾ã™ï¼ˆ8ã€œ12æšç¨‹åº¦ï¼‰ã€‚",
  tsukuru: "ã¤ãã‚‹ï¼šé¸ã‚“ã ã‚¢ã‚¤ãƒ‡ã‚¢ã®è¦‹ãŸç›®ãƒ»å¤§ãã•ãƒ»æ©Ÿèƒ½ãƒ»ç‰¹å¾´ã‚’æ•´ç†ã—ã¾ã™ï¼ˆ3ã€œ7æšç¨‹åº¦ï¼‰ã€‚",
  tamesu: "ãŸã‚ã™ï¼šè‰¯ã‹ã£ãŸç‚¹ï¼ã‚‚ã£ã¨è‰¯ãã§ããã†ãªç‚¹ï¼æ¬¡ã«ã™ã‚‹ã“ã¨ã‚’ã‚«ãƒ¼ãƒ‰ã§æ®‹ã—ã¾ã™ï¼ˆ4ã€œ6æšç¨‹åº¦ï¼‰ã€‚"
};
const nextPhaseOptions = {
  saguru:  { forward: "kizuku",  back: null },
  kizuku:  { forward: "hirameku",back: "saguru" },
  hirameku:{ forward: "tsukuru", back: "kizuku" },
  tsukuru: { forward: "tamesu",  back: "hirameku" },
  tamesu:  { forward: "saguru",  back: "kizuku" }
};
function phaseLabel(p){
  return {saguru:"â‘ ã•ãã‚‹",kizuku:"â‘¡ãã¥ã",hirameku:"â‘¢ã²ã‚‰ã‚ã",tsukuru:"â‘£ã¤ãã‚‹",tamesu:"â‘¤ãŸã‚ã™"}[p] || p;
}

// æœ¬å½“ã®èª²é¡Œå…±æœ‰
const coreProblemInput = document.getElementById("coreProblemInput");
const coreProblemDisplay = document.getElementById("coreProblemDisplay");
const hiramekuCoreProblemText = document.getElementById("hiramekuCoreProblemText");
let coreProblemText = "";
if (coreProblemInput) {
  coreProblemInput.addEventListener("input", () => {
    coreProblemText = coreProblemInput.value;
    if (coreProblemDisplay) coreProblemDisplay.textContent = coreProblemText;
    if (hiramekuCoreProblemText) hiramekuCoreProblemText.textContent = coreProblemText;
  });
}

// ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
const canvasEl = document.getElementById("canvas");
const layoutClasses = ["layout-saguru-kizuku","layout-hirameku","layout-tsukuru","layout-tamesu"];
const areaTarget      = document.getElementById("area-target");
const areaFact        = document.getElementById("area-fact");
const areaWish        = document.getElementById("area-wish");
const areaInterpret   = document.getElementById("area-interpret");
const hiramekuCore    = document.getElementById("hirameku-core");
const ideaSlots = [
  document.getElementById("hirameku-idea-slot-1"),
  document.getElementById("hirameku-idea-slot-2"),
  document.getElementById("hirameku-idea-slot-3"),
  document.getElementById("hirameku-idea-slot-4")
];
const areaIdeaName    = document.getElementById("area-idea-name");
const areaCoreProblem = document.getElementById("area-core-problem");
const areaLook        = document.getElementById("area-look");
const areaSize        = document.getElementById("area-size");
const areaFunction    = document.getElementById("area-function");
const areaFeature     = document.getElementById("area-feature");
const areaGood        = document.getElementById("area-good");
const areaBetter      = document.getElementById("area-better");
const areaNext        = document.getElementById("area-next");

function setWorksheetLayout(phase) {
  layoutClasses.forEach(c => canvasEl.classList.remove(c));
  [
    areaTarget,areaFact,areaWish,areaInterpret,
    hiramekuCore,...ideaSlots,
    areaIdeaName,areaCoreProblem,areaLook,areaSize,areaFunction,areaFeature,
    areaGood,areaBetter,areaNext
  ].forEach(el => { if(el) el.style.display="none"; });

  if (phase==="saguru" || phase==="kizuku") {
    canvasEl.classList.add("layout-saguru-kizuku");
    if (areaTarget) areaTarget.style.display="block";
    if (areaFact) areaFact.style.display="block";
    if (areaWish) areaWish.style.display="block";
    if (areaInterpret) areaInterpret.style.display="block";
    worksheetPhaseLabel.textContent = "ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆï¼šã•ãã‚‹ãƒ»æ°—ã¥ããƒ»ãŸã¦ã‚‹";
  } else if (phase==="hirameku") {
    canvasEl.classList.add("layout-hirameku");
    if (hiramekuCore) hiramekuCore.style.display="block";
    ideaSlots.forEach(el=>{ if(el) el.style.display="block"; });
    const w = canvasEl.clientWidth || 800;
    const h = canvasEl.clientHeight || 400;
    const mx = w*0.06, my=h*0.06;
    ideaSlots[0].style.left  = mx+"px";  ideaSlots[0].style.top   = my+"px";
    ideaSlots[1].style.right = mx+"px";  ideaSlots[1].style.top   = my+"px"; ideaSlots[1].style.left="";
    ideaSlots[2].style.left  = mx+"px";  ideaSlots[2].style.bottom= my+"px"; ideaSlots[2].style.top="";
    ideaSlots[3].style.right = mx+"px";  ideaSlots[3].style.bottom= my+"px"; ideaSlots[3].style.top="";
    worksheetPhaseLabel.textContent = "ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆï¼šâ‘¢ã²ã‚‰ã‚ãï¼ˆã‚¢ã‚¤ãƒ‡ã‚¢å‡ºã—ï¼‰";
  } else if (phase==="tsukuru") {
    canvasEl.classList.add("layout-tsukuru");
    if (areaIdeaName) areaIdeaName.style.display="block";
    if (areaCoreProblem) areaCoreProblem.style.display="block";
    if (areaLook) areaLook.style.display="block";
    if (areaSize) areaSize.style.display="block";
    if (areaFunction) areaFunction.style.display="block";
    if (areaFeature) areaFeature.style.display="block";
    worksheetPhaseLabel.textContent = "ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆï¼šâ‘£ã¤ãã‚‹ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰";
  } else if (phase==="tamesu") {
    canvasEl.classList.add("layout-tamesu");
    if (areaGood) areaGood.style.display="block";
    if (areaBetter) areaBetter.style.display="block";
    if (areaNext) areaNext.style.display="block";
    worksheetPhaseLabel.textContent = "ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆï¼šâ‘¤ãŸã‚ã™ï¼ˆãƒ†ã‚¹ãƒˆã¨æŒ¯ã‚Šè¿”ã‚Šï¼‰";
  }

  if (coreProblemInput) coreProblemInput.value = coreProblemText;
  updateNotesVisibility();
}

function updatePhaseDotsHighlight() {
  Object.entries(phaseDots).forEach(([ph,dot])=>{
    dot.classList.remove("current","visited");
    if (ph===currentPhase) dot.classList.add("current");
    else if (visitedPhases.has(ph)) dot.classList.add("visited");
  });
}

function updateNextPhaseButtons() {
  const cfg = nextPhaseOptions[currentPhase];
  nextPhaseButtons.innerHTML = "";
  if (!cfg) return;
  const span = document.createElement("span");
  span.textContent = "â–¶ æ¬¡ã®ä¸€æ­©ï¼ˆä¾‹ï¼‰ï¼š";
  nextPhaseButtons.appendChild(span);
  if (cfg.forward) {
    const bF = document.createElement("button");
    bF.textContent = "æ¬¡ã¸ï¼šã€Œ" + phaseLabel(cfg.forward) + "ã€";
    bF.onclick = () => changePhase(cfg.forward);
    nextPhaseButtons.appendChild(bF);
  }
  if (cfg.back) {
    const bB = document.createElement("button");
    bB.textContent = "æˆ»ã‚‹ï¼šã€Œ" + phaseLabel(cfg.back) + "ã€";
    bB.onclick = () => changePhase(cfg.back);
    nextPhaseButtons.appendChild(bB);
  }
}

function changePhase(newPhase) {
  currentPhase = newPhase;
  visitedPhases.add(newPhase);
  setWorksheetLayout(newPhase);
  updatePhaseDotsHighlight();
  updateNextPhaseButtons();
}

// ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«ä»˜ç®‹ã‚’éè¡¨ç¤ºï¼è¡¨ç¤º
function updateNotesVisibility() {
  document.querySelectorAll(".note").forEach(note => {
    const notePhase = note.dataset.phase || "";
    note.style.display = (notePhase === currentPhase) ? "block" : "none";
  });
}

// å††ãƒœã‚¿ãƒ³
Object.values(phaseDots).forEach(dot=>{
  dot.addEventListener("click",()=>{
    const ph = dot.dataset.phase;
    if (ph) changePhase(ph);
  });
});

// åˆæœŸåŒ–
changePhase("saguru");

// ==== ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› ====
const keywordInput       = document.getElementById("keywordInput");
const addKeywordBtn      = document.getElementById("addKeywordBtn");
const keywordsUserEl     = document.getElementById("keywords-user");
const keywordsAiEl       = document.getElementById("keywords-ai");
const subjectSelect      = document.getElementById("subjectSelect");

addKeywordBtn.onclick = () => {
  const text = keywordInput.value.trim();
  if (!text) return;
  const subject = subjectSelect.value;

  const card = document.createElement("div");
  card.className = "keyword-card";
  card.draggable = true;
  card.dataset.keyword = text;
  card.dataset.subject = subject;

  const spanMain = document.createElement("div");
  spanMain.textContent = text;
  card.appendChild(spanMain);

  if (subject) {
    const spanBadge = document.createElement("span");
    spanBadge.className = "subject-badge";
    spanBadge.textContent = subject;
    card.appendChild(spanBadge);
  }

  keywordsUserEl.appendChild(card);
  keywordInput.value = "";
};

// ==== éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ====
const rawMemoEl          = document.getElementById("rawMemo");
const audioFileInput     = document.getElementById("audioFileInput");
const uploadAudioBtn     = document.getElementById("uploadAudioBtn");
const transcribeStatus   = document.getElementById("transcribeStatus");

uploadAudioBtn.onclick = async () => {
  const file = audioFileInput.files[0];
  if (!file) {
    transcribeStatus.textContent = "éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
    return;
  }
  transcribeStatus.textContent = "éŸ³å£°ã‚’é€ä¿¡ä¸­â€¦";
  uploadAudioBtn.disabled = true;
  try {
    const formData = new FormData();
    formData.append("audio", file);
    const res = await fetch("/api/transcribe", {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    if (!res.ok || !data.ok) {
      const msg = data.error || `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${res.status})`;
      transcribeStatus.textContent = "æ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼: " + msg;
      uploadAudioBtn.disabled = false;
      return;
    }
    const text = data.text || "";
    if (text) {
      if (rawMemoEl.value && !rawMemoEl.value.endsWith("\n")) rawMemoEl.value += "\n";
      rawMemoEl.value += text;
      transcribeStatus.textContent = "æ–‡å­—èµ·ã“ã—å®Œäº†ï¼šãƒ¡ãƒ¢æ¬„ã«è¿½è¨˜ã—ã¾ã—ãŸã€‚";
    } else {
      transcribeStatus.textContent = "ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã—ãŸã€‚éŸ³å£°ãŒçŸ­ã™ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚";
    }
  } catch (e) {
    transcribeStatus.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e;
  } finally {
    uploadAudioBtn.disabled = false;
  }
};

// ==== ãƒ–ãƒ©ã‚¦ã‚¶éŒ²éŸ³ï¼ˆVAD ä»˜ãè‡ªå‹•åœæ­¢ç‰ˆï¼‰ ====
const startRecordBtn = document.getElementById("startRecordBtn");
const stopRecordBtn  = document.getElementById("stopRecordBtn");
const recordStatus   = document.getElementById("recordStatus");

let mediaRecorder = null;
let recordedChunks = [];

// VAD ç”¨
let audioContext = null;
let analyser = null;
let vadDataArray = null;
let lastVoiceTime = 0;
let vadRunning = false;

const VAD_CONFIG = {
  volumeThreshold: 0.002,  // â† è¶…æ•æ„Ÿã«ï¼
  silenceDuration: 1500,   // 1.5ç§’ã§åœæ­¢
};


function stopRecordingInternal() {
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    recordStatus.textContent = "éŒ²éŸ³åœæ­¢å‡¦ç†ä¸­â€¦";
  }
  vadRunning = false;
}

function startVadLoop() {
  if (!analyser || !vadDataArray) return;
  vadRunning = true;
  lastVoiceTime = Date.now();

  const loop = () => {
    if (!vadRunning) return;
    analyser.getByteFrequencyData(vadDataArray);
    const avg =
      vadDataArray.reduce((a, b) => a + b, 0) / (vadDataArray.length || 1) / 255;

    if (avg > VAD_CONFIG.volumeThreshold) {
      // å£°ãŒå‡ºã¦ã„ã‚‹
      lastVoiceTime = Date.now();
      recordStatus.textContent = "éŒ²éŸ³ä¸­â€¦ï¼ˆè©±ã—åˆã„ä¸­ï¼‰";
    } else {
      // ç„¡éŸ³ãŒç¶šã„ã¦ã„ã‚‹ã‹ç¢ºèª
      const silentMs = Date.now() - lastVoiceTime;
      if (silentMs > VAD_CONFIG.silenceDuration) {
        recordStatus.textContent = "ç„¡éŸ³ãŒç¶šã„ãŸãŸã‚è‡ªå‹•åœæ­¢ã—ã¾ã™â€¦";
        stopRecordingInternal();
        return;
      }
    }
    requestAnimationFrame(loop);
  };

  loop();
}

startRecordBtn.onclick = async () => {
  if (mediaRecorder && mediaRecorder.state === "recording") return;
  recordStatus.textContent = "ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„â€¦";
  startRecordBtn.disabled = true;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // VAD ç”¨ AudioContext æº–å‚™
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    vadDataArray = new Uint8Array(bufferLength);
    source.connect(analyser);

    recordedChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstart = () => {
      recordStatus.textContent = "éŒ²éŸ³ä¸­â€¦ï¼ˆè©±ã—åˆã„ã‚’ã—ã¦ãã ã•ã„ï¼‰";
      stopRecordBtn.disabled = false;
      startVadLoop();  // VAD ãƒ«ãƒ¼ãƒ—é–‹å§‹
    };

    mediaRecorder.onstop = async () => {
      vadRunning = false;
      stopRecordBtn.disabled = true;

      const blob = new Blob(recordedChunks, { type: "audio/webm" });
      recordedChunks = [];

      recordStatus.textContent = "éŒ²éŸ³çµ‚äº†ã€‚æ–‡å­—èµ·ã“ã—ä¸­â€¦";
      try {
        const formData = new FormData();
        formData.append("audio", blob, "recorded.webm");
        const res = await fetch("/api/transcribe", {
          method: "POST",
          body: formData,
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          const msg = data.error || `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${res.status})`;
          recordStatus.textContent = "æ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼: " + msg;
          return;
        }
        const text = data.text || "";
        if (text) {
          if (rawMemoEl.value && !rawMemoEl.value.endsWith("\n"))
            rawMemoEl.value += "\n";
          rawMemoEl.value += text;
          recordStatus.textContent =
            "æ–‡å­—èµ·ã“ã—å®Œäº†ï¼šãƒ¡ãƒ¢æ¬„ã«è¿½è¨˜ã—ã¾ã—ãŸã€‚";
        } else {
          recordStatus.textContent =
            "ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã—ãŸã€‚è©±ã—åˆã„ãŒçŸ­ã™ããŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚";
        }
      } catch (e) {
        recordStatus.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e;
      } finally {
        if (mediaRecorder && mediaRecorder.stream) {
          mediaRecorder.stream.getTracks().forEach((t) => t.stop());
        }
        mediaRecorder = null;
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
        startRecordBtn.disabled = false;
      }
    };

    mediaRecorder.start();
  } catch (e) {
    console.error(e);
    recordStatus.textContent =
      "ãƒã‚¤ã‚¯ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆè¨±å¯ã•ã‚Œã¦ã„ãªã„ã‹ã€ç«¯æœ«ãŒéå¯¾å¿œã§ã™ï¼‰ã€‚";
    startRecordBtn.disabled = false;
  }
};

// æ‰‹å‹•åœæ­¢ãƒœã‚¿ãƒ³ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»»æ„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ­¢ã‚ãŸã„ã¨ãç”¨ï¼‰
stopRecordBtn.onclick = () => {
  stopRecordingInternal();
};


// ==== AI ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‹å…ƒã‚»ãƒªãƒ•ï¼‰====
const aiKeywordBtn    = document.getElementById("aiKeywordBtn");
const aiKeywordStatus = document.getElementById("aiKeywordStatus");

aiKeywordBtn.onclick = async () => {
  const memoText = rawMemoEl.value.trim();
  if (!memoText) {
    aiKeywordStatus.textContent = "ãƒ¡ãƒ¢ãŒç©ºã§ã™ã€‚å…ˆã«æ–‡å­—èµ·ã“ã—ã‚„ãƒ¡ãƒ¢å…¥åŠ›ã‚’ã—ã¦ãã ã•ã„ã€‚";
    return;
  }
  const phase = currentPhase || "saguru";
  aiKeywordStatus.textContent = "AIã«é€ä¿¡ä¸­â€¦";
  aiKeywordBtn.disabled = true;
  try {
    const res = await fetch("/api/extract_keywords", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ memo: memoText, phase: phase })
    });
    const data = await res.json();
    if (!res.ok || !data.ok) {
      const msg = data.error || `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${res.status})`;
      aiKeywordStatus.textContent = "ã‚¨ãƒ©ãƒ¼: " + msg;
      aiKeywordBtn.disabled = false;
      return;
    }
    aiKeywordStatus.textContent = "ã‚«ãƒ¼ãƒ‰ã‚’å·¦ã®ã€è‡ªåˆ†ã§è¦‹ã¤ã‘ãŸï¼AIã‹ã‚‰ã‚‚ã‚‰ã£ãŸã‚«ãƒ¼ãƒ‰ã€ã«è¿½åŠ ã—ã¾ã—ãŸã€‚";

    keywordsAiEl.innerHTML = "";

    (data.keywords || []).forEach(item => {
      const kw    = typeof item === "string" ? item : (item.keyword || "");
      const quote = (typeof item === "object" && item.quote) ? item.quote : "";

      // ãƒ­ã‚°ç”¨
      const logCard = document.createElement("div");
      logCard.className = "keyword-card";
      logCard.draggable = true;
      logCard.dataset.keyword = kw;
      logCard.dataset.subject = "";
      const logMain = document.createElement("div");
      logMain.textContent = kw;
      logCard.appendChild(logMain);
      if (quote) {
        const logQuote = document.createElement("div");
        logQuote.className = "quote";
        logQuote.textContent = "ã€Œ" + quote + "ã€";
        logCard.appendChild(logQuote);
      }
      keywordsAiEl.appendChild(logCard);

      // å®Ÿéš›ã«ä½¿ã†ã‚«ãƒ¼ãƒ‰
      const card = document.createElement("div");
      card.className = "keyword-card";
      card.draggable = true;
      card.dataset.keyword = kw;
      card.dataset.subject = "";
      const spanMain = document.createElement("div");
      spanMain.textContent = kw;
      card.appendChild(spanMain);
      if (quote) {
        const spanQuote = document.createElement("div");
        spanQuote.className = "quote";
        spanQuote.textContent = "ã€Œ" + quote + "ã€";
        card.appendChild(spanQuote);
      }
      keywordsUserEl.appendChild(card);
    });
  } catch (e) {
    aiKeywordStatus.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e;
  } finally {
    aiKeywordBtn.disabled = false;
  }
};

// ==== ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— ====
function setupDragSource(container) {
  container.addEventListener("dragstart", (e) => {
    if (e.target.classList.contains("keyword-card")) {
      e.dataTransfer.setData("text/plain", e.target.dataset.keyword);
      e.dataTransfer.setData("subject", e.target.dataset.subject || "");
    }
  });
}
setupDragSource(keywordsUserEl);
setupDragSource(keywordsAiEl);

canvasEl.addEventListener("dragover", e => e.preventDefault());
canvasEl.addEventListener("drop", (e) => {
  e.preventDefault();
  const kw = e.dataTransfer.getData("text/plain");
  if (!kw) return;
  const subject = e.dataTransfer.getData("subject") || "";
  const rect = canvasEl.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const note = document.createElement("div");
  note.className = "note";
  note.dataset.subject = subject;
  note.dataset.phase = currentPhase;  // ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã®ä»˜ç®‹ã¨ã—ã¦è¨˜éŒ²
  note.style.left = x + "px";
  note.style.top  = y + "px";

  const spanText = document.createElement("div");
  spanText.textContent = kw;
  note.appendChild(spanText);

  if (subject) {
    const spanBadge = document.createElement("div");
    spanBadge.className = "subject-badge";
    spanBadge.textContent = subject;
    note.appendChild(spanBadge);
  }

  canvasEl.appendChild(note);
  makeNoteDraggable(note);
  updateNotesVisibility();
});

function makeNoteDraggable(note) {
  let isDragging = false;
  let startX = 0;
  let startY = 0;
  let origLeft = 0;
  let origTop = 0;
  note.addEventListener("mousedown", (e) => {
    e.preventDefault();
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    origLeft = note.offsetLeft;
    origTop = note.offsetTop;
    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);
  });
  function onMouseMove(e) {
    if (!isDragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    let newLeft = origLeft + dx;
    let newTop  = origTop + dy;
    const rect = canvasEl.getBoundingClientRect();
    const maxLeft = rect.width - note.offsetWidth;
    const maxTop  = rect.height - note.offsetHeight;
    newLeft = Math.max(0, Math.min(newLeft, maxLeft));
    newTop  = Math.max(0, Math.min(newTop, maxTop));
    note.style.left = newLeft + "px";
    note.style.top  = newTop + "px";
  }
  function onMouseUp() {
    isDragging = false;
    document.removeEventListener("mousemove", onMouseMove);
    document.removeEventListener("mouseup", onMouseUp);
  }
}

// å…ˆç”Ÿãƒ“ãƒ¥ãƒ¼ã®ãƒ€ãƒŸãƒ¼åˆ‡ã‚Šæ›¿ãˆ
const teamItems = document.querySelectorAll(".team-item");
const summaryText = document.getElementById("summaryText");
const feedbackList = document.getElementById("feedbackList");
const teacherSubjectBadge = document.getElementById("teacherSubjectBadge");
const dummyData = {
  A: {
    subjects:["æ¢ç©¶","ç¤¾ä¼š"],
    summary:"äº‹å®Ÿï¼š3æšï¼åŸå› ï¼š2æšï¼ã‚¢ã‚¤ãƒ‡ã‚¢ï¼š5æš\nãƒ»äº‹å®ŸãŒã‚„ã‚„å°‘ãªã‚\nãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢ãŒå¤šã„ãŒã€åŸå› ã¨ã¤ãªãŒã£ã¦ã„ãªã„ã‚‚ã®ã‚‚ã‚ã‚Šãã†",
    feedback:[
      "äº‹å®Ÿãƒ»ç¾çŠ¶ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚‚ã†å°‘ã—å¢—ã‚„ã™ã‚ˆã†å•ã„ã‹ã‘ã‚‹ã€‚",
      "ã‚¢ã‚¤ãƒ‡ã‚¢ã”ã¨ã«ã€Œã©ã®åŸå› ã«åŠ¹ããã†ã‹ï¼Ÿã€ã‚’èã„ã¦ã¿ã‚‹ã€‚",
      "æ¬¡ã«è©¦ã—ãŸã„ä¸€æ­©ã‚’1ã¤é¸ã°ã›ã€æœŸé™ã‚„å½¹å‰²ã‚’æ±ºã‚ã•ã›ã‚‹ã€‚"
    ]
  },
  B: {
    subjects:["å®¶åº­ç§‘","æ¢ç©¶"],
    summary:"äº‹å®Ÿï¼š5æšï¼åŸå› ï¼š4æšï¼ã‚¢ã‚¤ãƒ‡ã‚¢ï¼š2æš\nãƒ»äº‹å®Ÿã¨åŸå› ã¯ååˆ†\nãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢ãŒå°‘ãªãã€ç™ºæ•£ãŒè¶³ã‚Šãªã„ã‹ã‚‚ã—ã‚Œãªã„",
    feedback:[
      "åŸå› ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ãªãŒã‚‰ã€Œä»–ã«ã§ãã‚‹å·¥å¤«ã¯ï¼Ÿã€ã¨ã‚¢ã‚¤ãƒ‡ã‚¢å‡ºã—ã‚’ä¿ƒã™ã€‚",
      "å°ã•ãªè¡Œå‹•ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚‚æ­“è¿ã™ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹ã€‚",
      "ä¼¼ãŸã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã¾ã¨ã‚ã¦ã€å®Ÿè¡Œã—ã‚„ã™ã„å½¢ã«æ•´ç†ã™ã‚‹ã€‚"
    ]
  },
  C: {
    subjects:["å›³æ›¸","æ¢ç©¶"],
    summary:"äº‹å®Ÿï¼š2æšï¼åŸå› ï¼š1æšï¼ã‚¢ã‚¤ãƒ‡ã‚¢ï¼š4æš\nãƒ»å…¨ä½“çš„ã«ã‚«ãƒ¼ãƒ‰ãŒå°‘ãªã„\nãƒ»æ€ã„ã¤ãã®ã‚¢ã‚¤ãƒ‡ã‚¢ãŒå¤šãã€æ ¹æ‹ ãŒå¼±ã„å¯èƒ½æ€§",
    feedback:[
      "ã¾ãšäº‹å®Ÿã‚«ãƒ¼ãƒ‰ã‚’å¢—ã‚„ã—ã€åˆ©ç”¨è€…ã®å…·ä½“çš„ãªæ§˜å­ã‚’å¼•ãå‡ºã™ã€‚",
      "ã‚¢ã‚¤ãƒ‡ã‚¢ã”ã¨ã«ã€Œãªãœãã‚ŒãŒè‰¯ã•ãã†ã¨æ€ã£ãŸã‹ã€ã‚’è³ªå•ã™ã‚‹ã€‚",
      "æ¬¡ã®æ™‚é–“ã¾ã§ã«è¿½åŠ èª¿æŸ»ã—ã¦ãã‚‹ã‚¿ã‚¹ã‚¯ã‚’ææ¡ˆã™ã‚‹ã€‚"
    ]
  }
};
teamItems.forEach(item=>{
  item.addEventListener("click",()=>{
    teamItems.forEach(t=>t.classList.remove("active"));
    item.classList.add("active");
    const team=item.dataset.team;
    const data=dummyData[team];
    summaryText.textContent=data.summary;
    teacherSubjectBadge.innerHTML="æ•™ç§‘ã‚¿ã‚°ï¼š";
    data.subjects.forEach(sub=>{
      const span=document.createElement("span");
      span.className="teacher-subject-badge";
      span.textContent=sub;
      teacherSubjectBadge.appendChild(span);
    });
    feedbackList.innerHTML="";
    data.feedback.forEach(fb=>{
      const li=document.createElement("li");
      li.textContent=fb;
      feedbackList.appendChild(li);
    });
  });
});
</script>
</body>
</html>
